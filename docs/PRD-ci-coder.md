# PRD — CI‑Coder
*A coding‑assistant LLM for the Cognitive Infrastructure project*

| Item | Detail |
|------|--------|
| **Author** | Rashid Azarang Esfandiari |
| **Maintainer** | Core Engineering Guild |
| **Status** | Draft v1.0 |
| **Last Updated** | 2025‑04‑16 |

---

## 1 · Purpose

CI‑Coder is an AI pair‑programmer that lives inside the IDE (VS Code primary),
understands the repository structure, and automates routine engineering tasks:
validation scripts, GitHub Actions, schema tweaks, and small utility CLIs.  
It removes cognitive ballast so human engineers can focus on framework design.

---

## 2 · Scope

| In‑Scope | Out‑of‑Scope |
|----------|--------------|
| Generate / refactor shell, JS/TS, YAML | Heavy data ETL pipelines |
| Auto‑create GitHub branches & PRs | Full‑stack React components |
| Lint & test fixes | UI prototyping |
| CI workflow suggestions | Production infra provisioning |
| Source library maintenance | Content creation |

---

## 3 · User Stories

| # | As a | I want to | So that |
|---|------|----------|---------|
| 1 | Maintainer | get an auto‑generated GitHub Action when I add a JSON schema | the pipeline validates every PR |
| 2 | Contributor | ask "fix links" in chat | broken internal refs are patched instantly |
| 3 | Dev | scaffold a Jest test with one command | new utilities are covered from day‑1 |
| 4 | Author | add a source document and have all related files updated | my content is properly integrated and citable |
| 5 | Contributor | validate citations across documentation | content stays correctly referenced |

---

## 4 · Functional Requirements

1. **IDE Extension**  
   - Loads project tree + open buffers.  
   - Exposes `/ci` slash‑commands (e.g., `/ci action lint`).

2. **Contextual Code Gen**  
   - Reads `ci-schema.json`; suggests AJV validate snippets.  
   - Generates or updates GitHub Actions YAML with best practices.

3. **Repo Ops**  
   - Creates branches `ci-coder/<slug>`; never pushes to `main`.  
   - Opens PR with template, auto‑labels `ci‑coder`.

4. **Validation**  
   - Runs `npm test`, markdown‑lint, ajv schema check before commit.
   - Validates citation references against `sources/index.yaml`.

5. **Security & Permissions**  
   - Uses fine‑grained GitHub PAT (`contents:write`, `pull_requests:write`).  
   - Scrubs generated code for secrets.

6. **Logging & Explainability**  
   - Adds comment banner at top of each generated file:  
     `// generated by CI‑Coder on YYYY‑MM‑DD – rationale: <one‑line>`.

7. **Source Library Management**
   - Assists with adding new source documents to the repository.
   - Creates excerpt directories and templates for new sources.
   - Updates the index.yaml when new sources are added.

---

## 5 · Non‑Functional Requirements

| Metric | Target |
|--------|--------|
| Latency | ≤1 s first suggestion; ≤5 s large refactor |
| Uptime | 99 % during working hours |
| Mean Review Changes | <2 minor comments per CI‑Coder PR |
| Citation Accuracy | 100% valid citations |

---

## 6 · Success Metrics (KPIs)

1. **Dev Efficiency** – 25 % reduction in time spent on boilerplate commits.  
2. **PR Throughput** – CI‑Coder PRs merged / month ≥ 5.  
3. **CI Failures** – <5 % of CI‑Coder PRs fail automated checks post‑merge.
4. **Source Integration** – 100% of new source documents properly indexed and citable.

---

## 7 · Milestones & Timeline

| Milestone | Target Date | Deliverable |
|-----------|-------------|-------------|
| **M0** | +2 weeks | VS Code extension skeleton; chat panel loads context |
| **M1** | +4 weeks | Branch/PR creation; GitHub Action generator |
| **M2** | +8 weeks | Jest test scaffolder; "fix schema" command |
| **M3** | +12 weeks | Automated link‑checker fix & smart refactor engine |
| **M4** | +16 weeks | Source library management and citation validation |

---

## 8 · Open Questions

1. Should CI‑Coder auto‑resolve CI‑Writer lint failures?  
2. Preferred local model fallback if API rate‑limited?  
3. How to version CI‑Coder itself—semantic tags or hash?
4. Should excerpts be auto-generated for common sections of source documents?

---

## 9 · Appendix A — Slash‑Command Catalog (MVP)

| Command | Action |
|---------|--------|
| `/ci action lint` | Generate lint GitHub Action |
| `/ci schema validate` | Insert AJV validate script |
| `/ci jest scaffold <path>` | Add Jest test skeleton |
| `/ci links fix` | Scan / auto‑patch Markdown links |
| `/ci source add <path>` | Add a new source document to the library |
| `/ci source excerpt <id> <section>` | Generate an excerpt from a source |
| `/ci validate citations` | Check citations against index.yaml |

---

## 10 · Appendix B — Source Management System Guide for LLM

This section details how CI-Coder should maintain the source management system.

### Directory Structure

```
sources/
├── manuscripts/              # Full markdown versions of source documents
├── raw-pdf/                 # Original PDF files (Git LFS tracked)
├── excerpts/                # Chunked sections for efficient reference
│   ├── LOGICAL_ID_1/
│   │   ├── 001-section.md
│   │   └── ...
│   └── ...
├── index.yaml               # Maps logical IDs to file paths
├── README.md                # Overview of the source library
└── CONTRIBUTING.md          # Guide for adding new sources
```

### Core Files and Their Purpose

1. **`sources/index.yaml`**: The single source of truth mapping logical IDs to file paths
   - Format: `LOGICAL_ID: relative/path/to/file.md`
   - IDs must be ALL_CAPS with underscores and include publication year
   - Once published, IDs must never change

2. **`sources/excerpts/LOGICAL_ID/NNN-section.md`**: Chunked sections of documents
   - Should include YAML frontmatter with metadata
   - Used for efficient LLM processing and precise citation

3. **`tools/validate_citations.py`**: Validates citations in markdown files
   - Checks against `sources/index.yaml`
   - Regular expression: `<!--\s*cite:([A-Z0-9_]+).*?-->`

4. **`tools/excerpt.py`**: Extracts specific excerpts by ID and number
   - Can be used to generate context for CI-Writer

### Process Flows

#### Adding a New Source Document

1. Convert to markdown if possible
2. Place markdown in `sources/manuscripts/`
3. Place original in `sources/raw-pdf/` if binary
4. Add entry to `sources/index.yaml` with a unique logical ID
5. Create directory `sources/excerpts/LOGICAL_ID/`
6. Create excerpt files with sequential numbering (001, 002, etc.)
7. Ensure each excerpt has proper frontmatter

#### Citation Workflow

1. Citations use HTML comment format: `<!--cite:LOGICAL_ID p.XX-->`
2. Citations can include additional metadata: `<!--cite:LOGICAL_ID section="..." pages="..."-->`
3. Run `npm run validate:citations` to check all citations
4. CI-Writer can use citations to pull in relevant context

#### Excerpt Management

1. Excerpts should be 1-3 pages in length
2. Each excerpt must include metadata in frontmatter:
   ```yaml
   ---
   source: LOGICAL_ID
   title: "Section Title"
   pages: "12-15"
   context: "Brief description"
   ---
   ```
3. Excerpts are extracted using `tools/excerpt.py LOGICAL_ID NUMBER`

### Automation Responsibilities

CI-Coder should:

1. **Validate index integrity**:
   - Ensure all entries in `index.yaml` point to existing files
   - Warn about logical IDs that don't follow convention

2. **Citation management**:
   - Validate citations against `index.yaml`
   - Suggest corrections for invalid citations
   - Update citations if logical IDs change (rare)

3. **Excerpt assistance**:
   - Generate excerpt templates for new sources
   - Help split large documents into appropriate chunks
   - Ensure proper frontmatter in all excerpts

4. **Integration checks**:
   - Verify Git LFS is correctly tracking PDFs
   - Check that new sources appear in the SUMMARY.md if appropriate
   - Ensure Python dependencies for citation tools are installed

### Common Commands

```bash
# Add a new source document
npm run source:add path/to/document.md LOGICAL_ID

# Validate all citations
npm run validate:citations

# Extract a specific excerpt
npm run excerpt LOGICAL_ID 001

# Update all related sections after adding citations
npm run update-related
```

---

> **Governance Rule**: every CI‑Coder commit must pass `npm test && ajv` and
> receive one human approval. No exceptions. Additionally, all citation-related changes must pass `npm run validate:citations`. 